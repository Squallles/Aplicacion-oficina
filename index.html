<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Herramientas Financieras — Full v48</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#0f172a; --bg2:#111827; --glass: rgba(255,255,255,.08); --stroke: rgba(255,255,255,.12);
      --text:#e5e7eb; --muted:#94a3b8; --brand:#7c3aed; --brand-2:#06b6d4;
      --ok:#22c55e; --bad:#ef4444; --warn:#f59e0b;
      --radius:16px; --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(124,58,237,.35), transparent 60%),
        radial-gradient(1200px 600px at 90% 10%, rgba(6,182,212,.25), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      color:var(--text);
    }
    .container{max-width: 1080px; margin: 0 auto; padding: 28px 16px 80px}
    .grid{display:grid; gap:18px; grid-template-columns: repeat(12, 1fr);}
    .card{ grid-column: span 12; background: var(--glass); border: 1px solid var(--stroke); backdrop-filter: blur(12px);
      border-radius: var(--radius); box-shadow: var(--shadow); padding: 18px }
    @media (min-width: 880px){ .card.half{ grid-column: span 6 } }
    label{font-size:13px;color:#cbd5e1;display:block;margin:6px 0}
    input{ width:100%; padding:12px 14px; border-radius:12px; color:var(--text);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04)); border:1px solid var(--stroke) }
    .btn{ display:inline-flex; align-items:center; gap:8px; cursor:pointer; padding:10px 14px; border-radius:10px;
      border:1px solid var(--stroke); color:#fff; font-weight:700; background: linear-gradient(180deg, rgba(124,58,237,.9), rgba(6,182,212,.9)); box-shadow: 0 8px 22px rgba(124,58,237,.35) }
    .btn.subtle{ background: linear-gradient(180deg, rgba(255,255,255,.1), rgba(255,255,255,.06)); color:#e2e8f0; border:1px solid var(--stroke) }
    .btn.ghost{ background: rgba(255,255,255,.05); border:1px solid var(--stroke); color:#e2e8f0 }
    .result{margin-top:10px;font-weight:700}
    .note{font-size:12px;color:#94a3b8;margin-top:8px}
    .segmented{ display:flex; background:rgba(255,255,255,.08); border:1px solid var(--stroke); border-radius:999px; padding:4px; gap:4px; width:100%; max-width:440px; }
    .segmented button{ flex:1; padding:10px 12px; border-radius:999px; border:0; cursor:pointer; color:#e2e8f0; background:transparent; font-weight:700; }
    .segmented button.active{ background:#fff; color:#111827 }
    .box{padding:14px; border-radius:12px; border:1px dashed var(--stroke); background:rgba(255,255,255,.05)}
    .row2col{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
    .row4{display:grid;grid-template-columns:1fr;gap:14px;align-items:end}
    @media (min-width:600px){ .row4{grid-template-columns:repeat(2,1fr)} }
    @media (min-width:900px){ .row4{grid-template-columns:repeat(4,1fr)} }
    .controls{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:8px; flex-wrap:wrap}
    .checkline{display:flex; align-items:center; gap:12px; flex-wrap:wrap}
    .muted{color:#94a3b8; font-size:12px; margin-top:6px}
    .kbd{padding:2px 6px;border-radius:6px;background:rgba(255,255,255,.08);border:1px solid var(--stroke)}
    .badge{display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--stroke); background:rgba(255,255,255,.08); font-size:12px; margin-left:8px}
  </style>
</head>
<body>
  <div class="container">
    <div class="grid">
      <section class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <div>
            <h1 style="margin:0">Validadores y Calculadoras ✨</h1>
            <p class="note">Tarjetas · CCC/IBAN · Regla de 3 · Permanencia</p>
          </div>
          <button class="btn" id="btnDemo" type="button">Probar ejemplo</button>
        </div>
      </section>

      <!-- Tarjeta -->
      <section class="card half">
        <h3>1) Validador de Tarjetas (Luhn) <span id="cardBadge" class="badge">0/16</span></h3>
        <label>Número de tarjeta</label>
        <input id="cardNumber" type="text" inputmode="numeric" pattern="[0-9]*" spellcheck="false" autocapitalize="off" autocomplete="off" placeholder="1234 5678 9012 3456">
        <div class="muted" id="cardPretty"></div>
        <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap">
          <button class="btn" id="btnTarjeta" type="button">Validar</button>
          <button class="btn subtle" id="btnTarjetaClear" type="button">Limpiar</button>
          <button class="btn ghost" id="btnCopyCard" type="button" disabled>Copiar tarjeta</button>
        </div>
        <div id="resultadoTarjeta" class="result"></div>
      </section>

      <!-- CCC / IBAN -->
      <section class="card half">
        <h3>2) CCC España o IBAN ES → IBAN <span id="cccBadge" class="badge">0</span></h3>
        <label>Introduce <strong>CCC (20 dígitos)</strong> o <strong>IBAN ES (24)</strong>.</label>
        <input id="ccc" type="text" placeholder="0081 0052 00 0004400044 o ES72…" autocomplete="off" autocapitalize="off" spellcheck="false">
        <div class="muted" id="cccInfo">Estado</div>
        <div class="muted" id="cccPretty"></div>
        <div class="muted" id="ibanPreview"></div>
        <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap">
          <button class="btn" id="btnCCC" type="button">Validar</button>
          <button class="btn subtle" id="btnCCCClear" type="button">Limpiar</button>
          <button class="btn ghost" id="btnCopyCCC" type="button" disabled>Copiar CCC</button>
          <button class="btn ghost" id="btnCopyIban" type="button" disabled>Copiar IBAN</button>
        </div>
        <div id="resultadoCuenta" class="result"></div>
      </section>

      <!-- Regla de 3 -->
      <section class="card half">
        <h3>3) Calculadora de Regla de 3</h3>
        <div class="segmented">
          <button id="btnDirecta" class="active" type="button">Directa</button>
          <button id="btnInversa" type="button">Inversa</button>
        </div>
        <div class="row2col">
          <div><label>Valor A</label><input id="a" type="text"></div>
          <div><label>Valor B</label><input id="b" type="text"></div>
          <div><label>Valor C</label><input id="c" type="text"></div>
          <div><label>X</label><input id="x" type="text" disabled></div>
        </div>
        <div style="margin-top:14px; display:flex; gap:10px">
          <button class="btn" id="btnRegla" type="button">Calcular</button>
          <button class="btn subtle" id="btnReglaClear" type="button">Limpiar</button>
        </div>
        <div id="resultadoRegla" class="result"></div>
      </section>

      <!-- Permanencia -->
      <section class="card half">
        <h3>4) Penalización por Permanencia</h3>
        <div class="row4">
          <div><label>Cuota mensual (€)</label><input id="cuota" type="text"></div>
          <div><label>Inicio</label><input id="fechaInicio" type="date"></div>
          <div><label>Meses permanencia</label><input id="mesesPermanencia" type="text"></div>
          <div><label>Fecha baja</label><input id="fechaBaja" type="date"></div>
        </div>
        <div class="checkline">
          <label><input id="proporcional" type="checkbox" checked> Prorrateo</label>
          <label><input id="autoRenovar" type="checkbox" checked> Auto-renovar</label>
        </div>
        <div style="margin-top:10px; display:flex; gap:10px">
          <button class="btn" id="btnPermanencia" type="button">Calcular</button>
          <button class="btn subtle" id="btnPermanenciaClear" type="button">Limpiar</button>
        </div>
        <div id="resultadoPermanencia" class="result"></div>
        <div id="detallePermanencia" class="muted"></div>
      </section>
    </div>
  </div>

<script>
/* === Código JS v48 completo (funciona en iPhone) === */
/* Helpers */
function todayStr(){const t=new Date();return `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;}
function setTodayIfEmpty(){const baja=document.getElementById('fechaBaja');if(baja&&!baja.value){baja.value=todayStr();}}
window.addEventListener('DOMContentLoaded',setTodayIfEmpty);
window.addEventListener('pageshow',setTodayIfEmpty);
function addTap(id,fn){const el=document.getElementById(id);if(!el)return;el.addEventListener('click',e=>{e.preventDefault();fn();},{passive:false});}
function onlyDigits(s){return(s||'').replace(/\D/g,'');}

/* Tarjeta */
const cardInput=document.getElementById('cardNumber');const cardPretty=document.getElementById('cardPretty');const cardBadge=document.getElementById('cardBadge');const btnCopyCard=document.getElementById('btnCopyCard');
function normalizeCard(){let d=onlyDigits(cardInput.value);if(d.length>16)d=d.slice(0,16);cardInput.value=d;cardPretty.textContent=d?d.replace(/(.{4})/g,'$1 ').trim():'';cardBadge.textContent=`${d.length}/16`;btnCopyCard.disabled=d.length!==16;}
function luhnValid(num){let s=0,a=false;for(let i=num.length-1;i>=0;i--){let n=parseInt(num[i]);if(a){n*=2;if(n>9)n-=9;}s+=n;a=!a;}return s%10===0;}
function liveCard(){const num=onlyDigits(cardInput.value);if(!num)return; if(num.length<16){document.getElementById('resultadoTarjeta').textContent="⌛ faltan dígitos";return;}document.getElementById('resultadoTarjeta').textContent=luhnValid(num)?"✅ Tarjeta válida":"❌ Tarjeta inválida";}
['input','change','keyup','paste','blur'].forEach(ev=>cardInput.addEventListener(ev,()=>{normalizeCard();liveCard();}));
addTap('btnTarjeta',liveCard);
addTap('btnTarjetaClear',()=>{cardInput.value='';normalizeCard();document.getElementById('resultadoTarjeta').textContent='';});
addTap('btnCopyCard',()=>navigator.clipboard.writeText(cardInput.value));

/* CCC/IBAN (simplificado a ES) */
const ccc=document.getElementById('ccc');const info=document.getElementById('cccInfo');const res=document.getElementById('resultadoCuenta');const btnCCC=document.getElementById('btnCCC');const btnCCCClear=document.getElementById('btnCCCClear');
function validarCCC(c){return c.length===20;}
function calcIBAN(c){return "ES00"+c;}
function liveCCC(){let v=ccc.value.toUpperCase().replace(/[^0-9A-Z]/g,'');ccc.value=v; if(v.startsWith("ES")){info.textContent=`IBAN ${v.length}/24`; if(v.length===24){res.textContent="IBAN detectado: "+v;}} else {info.textContent=`CCC ${v.length}/20`; if(v.length===20){res.textContent="CCC detectado: "+v+" → IBAN: "+calcIBAN(v);}}}
['input','change','keyup','paste','blur'].forEach(ev=>ccc.addEventListener(ev,liveCCC));
addTap('btnCCC',liveCCC);addTap('btnCCCClear',()=>{ccc.value='';info.textContent='';res.textContent='';});

/* Regla de 3 */
let directa=true;addTap('btnDirecta',()=>{directa=true;});addTap('btnInversa',()=>{directa=false;});
addTap('btnRegla',()=>{const a=parseFloat(document.getElementById('a').value.replace(',','.'));const b=parseFloat(document.getElementById('b').value.replace(',','.'));const c=parseFloat(document.getElementById('c').value.replace(',','.'));if(isNaN(a)||isNaN(b)||isNaN(c))return;let x=directa?(b*c)/a:(a*b)/c;document.getElementById('x').value=x;document.getElementById('resultadoRegla').textContent="X = "+x;});
addTap('btnReglaClear',()=>{['a','b','c','x'].forEach(id=>document.getElementById(id).value='');document.getElementById('resultadoRegla').textContent='';});

/* Permanencia */
function addMonths(d,m){const r=new Date(d);r.setMonth(r.getMonth()+m);return r;}
function calcPen(){const cuota=parseFloat(document.getElementById('cuota').value.replace(',','.'));const ini=document.getElementById('fechaInicio').value;const m=parseInt(document.getElementById('mesesPermanencia').value);const baja=document.getElementById('fechaBaja').value;if(isNaN(cuota)||!ini||isNaN(m)||!baja)return;const iniD=new Date(ini);const bajaD=new Date(baja);let fin=addMonths(iniD,m);if(bajaD>=fin){document.getElementById('resultadoPermanencia').textContent="✅ Sin penalización";return;}const meses=(fin.getFullYear()-bajaD.getFullYear())*12+(fin.getMonth()-bajaD.getMonth());const total=meses*cuota;document.getElementById('resultadoPermanencia').textContent="❌ Penalización: "+total.toFixed(2)+" €";}
['input','change'].forEach(ev=>['cuota','fechaInicio','mesesPermanencia','fechaBaja'].forEach(id=>document.getElementById(id).addEventListener(ev,calcPen)));
addTap('btnPermanencia',calcPen);addTap('btnPermanenciaClear',()=>{['cuota','fechaInicio','mesesPermanencia'].forEach(id=>document.getElementById(id).value='');setTodayIfEmpty();document.getElementById('resultadoPermanencia').textContent='';});

/* Demo */
addTap('btnDemo',()=>{cardInput.value='4539319503436467';normalizeCard();liveCard();ccc.value='00810052000004400044';liveCCC();document.getElementById('a').value='2';document.getElementById('b').value='4';document.getElementById('c').value='8';document.getElementById('cuota').value='20';document.getElementById('fechaInicio').value='2025-01-01';document.getElementById('mesesPermanencia').value='24';setTodayIfEmpty();calcPen();});
</script>
</body>
</html>
